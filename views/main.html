<!DOCTYPE html>
<html>
  <head>
    <title>Canvas.FM</title>
    <link rel="stylesheet" href="/stylesheets/main.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/results.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/track_controls.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/search.css" type="text/css" media="screen" charset="utf-8">

    <script id='search-results-template' type='text/mustache'>
      <ul>
        {{#tracks}}
          <li data-track-id="{{id}}">
            <div class="left">
              <img src="{{artworkUrl}}"></img>
            </div>
            <div class="right">
              <h3>{{title}}</h3>
              <h4>{{artistName}}</h4>
            </div>
          </li>
        {{/tracks}}
        {{^tracks}}
          <h2>No tracks found.</h2>
        {{/tracks}}
      </ul>
    </script>

    <script id='track-controls-template' type='text/mustache'>
      <div>
        <h2>{{title}}</h2><span> : </span>
        <h3>{{artistName}}</h3>
        <span title="pause track" class='button pause'></span>
        <a href="#" class='button download' download target="_blank" title="download image">Download</a>
      </div>
    </script>

  </head>
  <body>
    <div id="wrap">
      <header>
        <form id="search" action="/search">
          <input id="search-input" name="query" type="text" placeholder="Search SoundCloud"></input>
          <input type="submit" value="Go">
        </form>
        <h1><a href="/">Canvas.fm</a></h1>
      </header>

      <section id="search-results-container"></section>

      <section id="track-controls-container"></section>

      <section id="canvas-container">
        <canvas id="circle" width="1024" height="1024"></canvas>
      </section>

      <section class="audio-container">
        <audio id="audio"
               controls="true"
               preload
               autobuffer>
        </audio>
      </section>

      <a id="download" download>Download</a>
    </div>

    <footer>
      
    </footer>
    <!-- scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://connect.soundcloud.com/2/latest.min.js" type="text/javascript"></script>
    <script src="https://raw.github.com/olivernn/davis.js/master/dist/davis-0.6.1.min.js" type="text/javascript" charset="utf-8"></script>

    <script src="/javascripts/supplement-0.1.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/dsp.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/audio.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/canvas.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/deferred.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/track.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/search.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/track_controls.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/mustache.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/poirot.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript" charset="utf-8">

      var setupDownloadLink = function () {
        var link = document.getElementById('download')
        link.href = canvas.toPng()
      }

      var app = Davis(function () {

        this.get('/', function (req) {
          
        })

        this.get('/search', function (req) {
          Track.search(req.params['query'])
            .then(search.displayTracks)
        })

        this.get('/tracks/:track_id', function (req) {
          Track.find(req.params['track_id'])
            .then(canvas.reset)
            .then(audio.loadTrack)
            .then(trackControls.loadTrack)
        })

        this.bind('start', function () {
          audio.init()
          canvas.init()
          search.init()
          trackControls.init()

          audio.onSample(function (sample, delta) {
            canvas.rotate((delta / audio.duration()) * (Math.PI * 2))
            canvas.draw(sample)
          })
        })
      })

      app.start()
    </script>
  </body>
</html>